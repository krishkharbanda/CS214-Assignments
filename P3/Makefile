CC = gcc
CFLAGS = -Wall -Werror -std=c99 -D_POSIX_C_SOURCE=200809L -Iinclude
LDFLAGS =
SRC_DIR = src
INC_DIR = include
TEST_DIR = tests

SOURCES = $(SRC_DIR)/main.c $(SRC_DIR)/shell.c $(SRC_DIR)/parse.c $(SRC_DIR)/exec.c
OBJECTS = $(SOURCES:.c=.o)
EXECUTABLE = mysh

TEST_SCRIPTS = test_builtins.sh test_exec.sh test_redir_pipe.sh test_conditionals.sh

all: $(EXECUTABLE)

$(EXECUTABLE): $(OBJECTS)
	$(CC) $(LDFLAGS) -o $@ $(OBJECTS)

$(SRC_DIR)/%.o: $(SRC_DIR)/%.c $(INC_DIR)/mysh.h
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	rm -f $(SRC_DIR)/*.o $(EXECUTABLE)

clean_tests:
	rm -f output_test_1.txt output_test_2.txt output_test_3.txt input_test_1.txt
	rmdir test_dir_1 2>/dev/null || true # Ignore error if directory doesn't exist

test: $(EXECUTABLE)
	@echo "--- RUNNING ALL MYSH TESTS ---"
	@echo "Note: The conditional test script will terminate mysh with 'die'."
	
	@echo "\n--- 1. Testing Built-in Commands ---"
	@./$(EXECUTABLE) $(TEST_DIR)/test_builtins.sh
	
	@echo "\n--- 2. Testing Execution & Pathing ---"
	@./$(EXECUTABLE) $(TEST_DIR)/test_exec.sh
	
	@echo "\n--- 3. Testing Redirection & Pipes ---"
	@./$(EXECUTABLE) $(TEST_DIR)/test_redir_pipe.sh
	
	@echo "\n--- 4. Testing Conditionals (Will terminate with die) ---"
	@./$(EXECUTABLE) $(TEST_DIR)/test_conditionals.sh
	
	@echo "\n--- Cleaning up temporary test files ---"
	@make clean_tests

.PHONY: all clean clean_tests test help

help:
	@echo "Makefile targets:"
	@echo "  make all        - Build mysh"
	@echo "  make clean      - Remove build artifacts"
	@echo "  make test       - Run all comprehensive tests (built-ins, exec, pipes, conditionals)"
	@echo "  make clean_tests- Remove files generated by test scripts (e.g., output.txt, test_dir)"
	@echo "  make help       - Show this help message"